{
  "name": "Thingsboard application",
  "description": "Thingsboard microservices and gateway, Nalej ingestion layer",
  "labels": {
    "app": "thingsboard-app"
  },
  "rules": [
    {
      "rule_id": "public-tb-web-ui",
      "name": "Web UI open",
      "target_service_group_name": "g1",
      "target_service_name": "tbwebui",
      "target_port": 8080,
      "access": 2
    },
    {
      "rule_id": "to-zookeeper",
      "name": "Allow access to zookeeper",
      "target_service_group_name": "g1",
      "target_service_name": "zookeeper",
      "target_port": 1883,
      "access": 1,
      "auth_services": [
        "kafkasvc",
        "tbnode"
      ]
    },
    {
      "rule_id": "to-kafka",
      "name": "Allow access to Kafka",
      "target_service_group_name": "g1",
      "target_service_name": "kafkasvc",
      "target_port": 9092,
      "access": 1,
      "auth_services": [
        "tbjsexecutor",
        "tbmqtttransport",
        "tbnode"
      ]
    },
    {
      "rule_id": "to-redis",
      "name": "Allow access to Redis",
      "target_service_group_name": "g1",
      "target_service_name": "redis",
      "target_port": 6379,
      "access": 1,
      "auth_services": [
        "tbnode"
      ]
    },
    {
      "rule_id": "to-cassandra",
      "name": "Allow access to cassandra",
      "target_service_group_name": "g1",
      "target_service_name": "cassandra",
      "target_port": 2181,
      "access": 1,
      "auth_services": [
        "tbnode"
      ]
    },
    {
      "rule_id": "to-tbmqtttransport",
      "name": "Allow access to tbmqtttransport",
      "target_service_group_name": "g1",
      "target_service_name": "tbmqtttransport",
      "target_port": 1883,
      "access": 1,
      "auth_services": [
        "kafkasvc",
        "mqttdeviceclient",
        "tbgateway"
      ]
    },
    {
      "rule_id": "to-tb-node",
      "name": "Allow access to tb-node",
      "target_service_group_name": "g1",
      "target_service_name": "tbnode",
      "target_port": 8080,
      "access": 1,
      "auth_services": [
        "zookeeper",
        "redis",
        "tbwebui"
      ]
    },
    {
      "rule_id": "to-gateway",
      "name": "Allow access to gateway",
      "target_service_group_name": "g1",
      "target_service_name": "tbgateway",
      "target_port": 9090,
      "access": 1,
      "auth_services": [
        "tbnode",
        "mqtt"
      ]
    },
    {
      "rule_id": "to-mqtt",
      "name": "Allow access to nalej mqtt",
      "target_service_group_name": "g1",
      "target_service_name": "mqtt",
      "target_port": 1883,
      "access": 1,
      "auth_services": [
        "tbgateway",
        "mqttdeviceclient"
      ]
    },
    {"rule_id":"dg-access",
      "name": "allow access to mqtt from device groups",
      "target_service_group_name": "gateway",
      "target_service_name": "mqtt",
      "target_port": 1883,
      "access": 3,
      "device_groups":["4582d00a-5a6a-4543-95ec-f6cab58507c1"]
    },
    {"rule_id":"dg-access-mqtt-web",
      "name": "allow access to mqtt web",
      "target_service_group_name": "gateway",
      "target_service_name": "mqtt",
      "target_port": 8888,
      "access": 2
    }
  ],
  "groups": [
    {
      "name": "g1",
      "services": [
        {
          "service_group_id": "g1",
          "service_id": "zookeeper",
          "name": "zookeeper",
          "description": "Zookeeper service",
          "image": "zookeeper:3.5",
          "specs": {
            "replicas": 1
          },
          "exposed_ports": [
            {
              "name": "zookeeper-port",
              "internal_port": 2181,
              "exposed_port": 2181
            }
          ],
          "environment_variables": {
            "ZOO_MY_ID": "1",
            "ZOO_SERVERS": "server.1=0.0.0.0:2888:3888;0.0.0.0:2181"
          },
          "labels": {
            "app": "zookeeper",
            "component": "thingsboard-app"
          }
        },
        {
          "service_group_id": "g1",
          "service_id": "kafkasvc",
          "name": "kafkasvc",
          "description": "Kafka service",
          "image": "wurstmeister/kafka",
          "specs": {
            "replicas": 1
          },
          "exposed_ports": [
            {
              "name": "kafka-port",
              "internal_port": 9092,
              "exposed_port": 9092
            }
          ],
          "environment_variables": {
            "KAFKA_ADVERTISED_LISTENERS": "INSIDE://:9093,OUTSIDE://NALEJ_SERV_KAFKASVC:9092",
            "KAFKA_AUTO_CREATE_TOPICS_ENABLE": "false",
            "KAFKA_CREATE_TOPICS": "js.eval.requests:100:1:delete --config=retention.ms=60000 --config=segment.bytes=26214400\n  --config=retention.bytes=104857600,tb.transport.api.requests:30:1:delete --config=retention.ms=60000\n  --config=segment.bytes=26214400 --config=retention.bytes=104857600,tb.rule-engine:30:1:delete\n  --config=retention.ms=60000 --config=segment.bytes=26214400 --config=retention.bytes=104857600",
            "KAFKA_INTER_BROKER_LISTENER_NAME": "INSIDE",
            "KAFKA_LISTENER_SECURITY_PROTOCOL_MAP": "INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT",
            "KAFKA_LISTENERS": "INSIDE://:9093,OUTSIDE://:9092",
            "KAFKA_LOG_CLEANUP_POLICY": "delete",
            "KAFKA_LOG_RETENTION_BYTES": "1073741824",
            "KAFKA_LOG_RETENTION_MS": "300000",
            "KAFKA_LOG_SEGMENT_BYTES": "268435456",
            "KAFKA_ZOOKEEPER_CONNECT": "NALEJ_SERV_ZOOKEEPER:2181"
          },
          "labels": {
            "app": "kafkasvc",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "zookeeper"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "redis",
          "name": "redis",
          "description": "Redis service",
          "image": "redis:4.0",
          "specs": {
            "replicas": 1
          },
          "exposed_ports": [
            {
              "name": "redis-port",
              "internal_port": 6379,
              "exposed_port": 6379
            }
          ],
          "labels": {
            "app": "redis",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "kafkasvc"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "cassandra",
          "name": "cassandra",
          "description": "Cassandra service",
          "image": "cassandra:3.11.3",
          "specs": {
            "replicas": 1
          },
          "storage": [
            {
              "size": 5368709120,
              "mount_path": "/var/lib/cassandra",
              "type": 1
            }
          ],
          "exposed_ports": [
            {
              "name": "cassandra-port",
              "internal_port": 9042,
              "exposed_port": 9042
            }
          ],
          "labels": {
            "app": "cassandra",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "redis"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "tbjsexecutor",
          "name": "tbjsexecutor",
          "description": "tbjsexecutor service",
          "image": "thingsboard/tb-js-executor:latest",
          "specs": {
            "replicas": 1
          },
          "environment_variables": {
            "DOCKER_MODE": "true",
            "LOG_FOLDER": "logs",
            "LOGGER_FILENAME": "tbjsexecutor-%DATE%.log",
            "LOGGER_LEVEL": "info",
            "REMOTE_JS_EVAL_REQUEST_TOPIC": "js.eval.requests",
            "TB_KAFKA_SERVERS": "NALEJ_SERV_KAFKASVC:9092"
          },
          "labels": {
            "app": "tbjsexecutor",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "cassandra"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "tbmqtttransport",
          "name": "tbmqtttransport",
          "description": "tbmqtttransport service",
          "image": "nalejregistry.azurecr.io/thingsboard/tb-mqtt-transport:1.0",
          "credentials": {
            "username": "ec31156a-3874-42f4-823a-e67af7db4281",
            "password": "Iw<BbzK>)*sRuJz4@{C&=v!#Wfx1)1F+",
            "email": "jlopez@daisho.group",
            "docker_repository": "https://nalejregistry.azurecr.io"
          },
          "specs": {
            "replicas": 1
          },
          "exposed_ports": [
            {
              "name": "tb-mqtt-port",
              "internal_port": 1883,
              "exposed_port": 1883
            }
          ],
          "environment_variables": {
            "MQTT_BIND_ADDRESS": "0.0.0.0",
            "MQTT_BIND_PORT": "1883",
            "MQTT_TIMEOUT": "10000",
            "TB_KAFKA_SERVERS": "NALEJ_SERV_KAFKASVC:9092",
            "TB_HOST": "NALEJ_SERV_TBMQTTTRANSPORT",
            "CLUSTER_NODE_ID": "NALEJ_SERV_TBMQTTTRANSPORT"
          },
          "labels": {
            "app": "tbmqtttransport",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "cassandra"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "tbnode",
          "name": "tbnode",
          "description": "tbnode service",
          "image": "nalejregistry.azurecr.io/thingsboard/tb-node_no:1.0",
          "credentials": {
            "username": "ec31156a-3874-42f4-823a-e67af7db4281",
            "password": "Iw<BbzK>)*sRuJz4@{C&=v!#Wfx1)1F+",
            "email": "jlopez@daisho.group",
            "docker_repository": "https://nalejregistry.azurecr.io"
          },
          "specs": {
            "replicas": 1
          },
          "exposed_ports": [
            {
              "name": "tb-node-port",
              "internal_port": 8080,
              "exposed_port": 8080
            }
          ],
          "environment_variables": {
            "CACHE_TYPE": "redis",
            "HTTP_LOG_CONTROLLER_ERROR_STACK_TRACE": "false",
            "JS_EVALUATOR": "remote",
            "REDIS_HOST": "NALEJ_SERV_REDIS",
            "REDIS_PORT": "6379",
            "RPC_HOST": "NALEJ_SERV_TBNODE",
            "TB_KAFKA_SERVERS": "NALEJ_SERV_KAFKASVC:9092",
            "TRANSPORT_TYPE": "remote",
            "ZOOKEEPER_ENABLED": "true",
            "ZOOKEEPER_URL": "NALEJ_SERV_ZOOKEEPER:2181",
            "CASSANDRA_URL": "NALEJ_SERV_CASSANDRA:9042",
            "DATABASE_ENTITIES_TYPE": "cassandra",
            "DATABASE_TS_TYPE": "cassandra",
            "INSTALL_TB": "false",
            "LOAD_DEMO": "false",
            "TB_HOST": "NALEJ_SERV_TBNODE",
            "CLUSTER_NODE_ID": "NALEJ_SERV_TBNODE"
          },
          "labels": {
            "app": "tbnode",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "tbmqtttransport"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "tbwebui",
          "name": "tbwebui",
          "description": "Tb-web-ui service",
          "image": "thingsboard/tb-web-ui:latest",
          "specs": {
            "replicas": 1
          },
          "exposed_ports": [
            {
              "name": "tb-web-ui-port",
              "internal_port": 8080,
              "exposed_port": 8080,
              "endpoints": [
                {
                  "type": 2,
                  "path": "/"
                }
              ]
            }
          ],
          "environment_variables": {
            "DOCKER_MODE": "true",
            "HTTP_BIND_ADDRESS": "0.0.0.0",
            "HTTP_BIND_PORT": "8080",
            "LOG_FOLDER": "logs",
            "LOGGER_FILENAME": "tb-web-ui-%DATE%.log",
            "LOGGER_LEVEL": "info",
            "TB_ENABLE_PROXY": "true",
            "TB_HOST": "NALEJ_SERV_TBNODE"
          },
          "labels": {
            "app": "tbwebui",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "tbnode"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "tbgateway",
          "name": "tbgateway",
          "description": "Thingsboard Gateway",
          "image": "nalejregistry.azurecr.io/thingsboard/tb-gateway:1.4",
          "credentials": {
            "username": "ec31156a-3874-42f4-823a-e67af7db4281",
            "password": "Iw<BbzK>)*sRuJz4@{C&=v!#Wfx1)1F+",
            "email": "jlopez@daisho.group",
            "docker_repository": "https://nalejregistry.azurecr.io"
          },
          "specs": {
            "replicas": 1
          },
          "exposed_ports": [
            {
              "name": "tbgateway-port",
              "internal_port": 9090,
              "exposed_port": 9090
            }
          ],
          "environment_variables": {
            "GATEWAY_ACCESS_TOKEN": "gateway_token",
            "GATEWAY_HOST": "NALEJ_SERV_TBMQTTTRANSPORT"
          },
          "labels": {
            "app": "tbgateway",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "tbwebui"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "mqtt",
          "name": "mqtt",
          "description": "VerneMQ MQTT message broker",
          "image": "nalejregistry.azurecr.io/nalej/vernemq:v0.0.1",
          "credentials": {
            "username": "ec31156a-3874-42f4-823a-e67af7db4281",
            "password": "Iw<BbzK>)*sRuJz4@{C&=v!#Wfx1)1F+",
            "email": "jlopez@daisho.group",
            "docker_repository": "https://nalejregistry.azurecr.io"
          },
          "specs": {
            "replicas": 1
          },
          "exposed_ports": [
            {
              "name": "mqtt-port",
              "internal_port": 1883,
              "exposed_port": 1883
            },
            {
              "name": "status-port",
              "internal_port": 8888,
              "exposed_port": 8888
            }
          ],
          "environment_variables": {
            "NALEJ_TRUSTED_HOST": "NALEJ_SERV_TBGATEWAY"
          },
          "labels": {
            "app": "ingestion-layer",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "gateway"
          ]
        },
        {
          "service_group_id": "g1",
          "service_id": "mqttdeviceclient",
          "name": "mqttdeviceclient",
          "description": "MQTT Device simulator application",
          "image": "nalejpublic.azurecr.io/nalej/mqtt-device-client:v1.3.0",
          "credentials": {
            "username": "ec31156a-3874-42f4-823a-e67af7db4281",
            "password": "Iw<BbzK>)*sRuJz4@{C&=v!#Wfx1)1F+",
            "email": "jlopez@daisho.group",
            "docker_repository": "https://nalejpublic.azurecr.io"
          },
          "specs": {
            "replicas": 1
          },
          "environment_variables": {
            "NALEJ_PLATFORM": "dhtest29.nalej.tech",
            "ORGANIZATION_ID": "1efea91a-3c55-4fd6-a443-cfd114b141a8",
            "DEVICE_GROUP_ID": "4582d00a-5a6a-4543-95ec-f6cab58507c1",
            "DEVICE_GROUP_API_KEY": "0f97fb20-8fdc-4a91-8693-5938614b642a"
          },
          "labels": {
            "app": "mqttdeviceclient",
            "component": "thingsboard-app"
          },
          "deploy_after": [
            "mqtt"
          ]
        }
      ],
      "specs": {
        "num_replicas": 1
      }
    }
  ]
}
